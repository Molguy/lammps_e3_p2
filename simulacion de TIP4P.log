# Reference: M. Orsi, Comparative assessment of the ELBA coarse-grained
# model for water, Molecular Physics (2014), 112, 1566-1576

units real
atom_style full
read_data singleTIP4P_05.dat
Reading data file ...
  orthogonal box = (0 0 0) to (3.1 3.1 3.1)
  1 by 1 by 1 MPI processor grid
  reading atoms ...
  3 atoms
  scanning bonds ...
  2 = max bonds/atom
  scanning angles ...
  1 = max angles/atom
  orthogonal box = (0 0 0) to (3.1 3.1 3.1)
  1 by 1 by 1 MPI processor grid
  reading bonds ...
  2 bonds
  reading angles ...
  1 angles
Finding 1-2 1-3 1-4 neighbors ...
  special bond factors lj:    0        0        0       
  special bond factors coul:  0        0        0       
     2 = max # of 1-2 neighbors
     1 = max # of 1-3 neighbors
     1 = max # of 1-4 neighbors
     2 = max # of special neighbors
  special bonds CPU = 0.001 seconds
  read_data CPU = 0.017 seconds
include forcefield.TIP4P_05.dat
# This forcefield file sets a 13-Angstrom cutoff, recommended for liquid-
# vapor simulations [Vega & de Miguel, J Chem Phys 126:154707 (2007),
# Vega et al, Faraday Discuss 141:251 (2009)]
# Note that the original TIP4P/2005 model was run with an 8.5 Angstrom
# cutoff [Abascal & Vega, J Chem Phys 123:234505 (2005)].
# Charges and geometry are specified in the "data." file.

mass 1 1.00794 # H
mass 2 15.9994 # O

pair_style lj/cut/tip4p/long 2 1 1 1 0.1546 13.0
pair_modify tail yes
kspace_style pppm/tip4p 1.0e-5

pair_coeff 1 1 0.0 0.0
pair_coeff 1 2 0.0 0.0
pair_coeff 2 2 0.18520 3.1589

bond_style harmonic
bond_coeff 1 0.0 0.9572

angle_style harmonic
angle_coeff 1 0.0 104.52

replicate 10 10 10
Replication is creating a 10x10x10 = 1000 times larger system...
  orthogonal box = (0 0 0) to (31 31 31)
  1 by 1 by 1 MPI processor grid
  3000 atoms
  2000 bonds
  1000 angles
Finding 1-2 1-3 1-4 neighbors ...
  special bond factors lj:    0        0        0       
  special bond factors coul:  0        0        0       
     2 = max # of 1-2 neighbors
     1 = max # of 1-3 neighbors
     1 = max # of 1-4 neighbors
     2 = max # of special neighbors
  special bonds CPU = 0.001 seconds
  replicate CPU = 0.015 seconds

variable Nrun equal 10000
variable Nf equal ${Nrun}/10
variable Nf equal 10000/10
variable Ne equal 10
variable Nr equal ${Nf}/${Ne}
variable Nr equal 1000/${Ne}
variable Nr equal 1000/10
variable Ndump equal ${Nrun}/2
variable Ndump equal 10000/2
variable Nr_rdf equal 0.5*${Nrun}/${Ne}
variable Nr_rdf equal 0.5*10000/${Ne}
variable Nr_rdf equal 0.5*10000/10
variable t  equal 1.0

variable watMoleMass equal 18.0153 # /(g/mol)
variable nAvog equal 6.0221415e23 # Avogadro's number
variable watMoleculeMass equal (${watMoleMass}/${nAvog}) # /(g/molecule)
variable watMoleculeMass equal (18.0153/${nAvog}) 
variable watMoleculeMass equal (18.0153/6.0221415e+23) 
variable A3_in_cm3 equal 1e-24 # Angstrom^3 in cm^3
variable nAtoms equal atoms
variable nMolecules equal v_nAtoms/3

variable Text equal 298.15
variable Pext equal 1.0

group hydrogen type 1
2000 atoms in group hydrogen
group oxygen type 2
1000 atoms in group oxygen

velocity all create ${Text} 1234
velocity all create 298.15 1234

neighbor 2.0 bin
neigh_modify every 1 delay 0 check yes

timestep 2.0

fix constrain all shake 1.0e-4 100 0 b 1 a 1
Finding SHAKE clusters ...
       0 = # of size 2 clusters
       0 = # of size 3 clusters
       0 = # of size 4 clusters
    1000 = # of frozen angles
  find clusters CPU = 0.002 seconds
fix integrate all npt temp ${Text} ${Text} 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 ${Text} 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso 1 ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso 1 1 1000.0
fix removeMomentum all momentum 1 linear 1 1 1

compute T all temp
fix TempAve all ave/time ${Ne} ${Nr} ${Nf} c_T
fix TempAve all ave/time 10 ${Nr} ${Nf} c_T
fix TempAve all ave/time 10 100 ${Nf} c_T
fix TempAve all ave/time 10 100 1000 c_T

variable P equal press
fix PressAve all ave/time ${Ne} ${Nr} ${Nf} v_P
fix PressAve all ave/time 10 ${Nr} ${Nf} v_P
fix PressAve all ave/time 10 100 ${Nf} v_P
fix PressAve all ave/time 10 100 1000 v_P

compute PE all pe pair kspace
variable PE_Mol equal c_PE/v_nMolecules
fix PEAve_Mol all ave/time ${Ne} ${Nr} ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 ${Nr} ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 100 ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 100 1000 v_PE_Mol

variable Dens equal v_nMolecules*${watMoleculeMass}/(vol*${A3_in_cm3})
variable Dens equal v_nMolecules*2.99151057808921e-23/(vol*${A3_in_cm3})
variable Dens equal v_nMolecules*2.99151057808921e-23/(vol*1e-24)
fix DensAve all ave/time ${Ne} ${Nr} ${Nf} v_Dens file twat.dens
fix DensAve all ave/time 10 ${Nr} ${Nf} v_Dens file twat.dens
fix DensAve all ave/time 10 100 ${Nf} v_Dens file twat.dens
fix DensAve all ave/time 10 100 1000 v_Dens file twat.dens

compute    	msd oxygen msd com yes
#compute         msd all msd com yes
variable        coe_diff equal (c_msd[4]/6/(step*dt+1.0e-6))/10e-5 #(1.0e-9 m^2/s)
fix             9 all vector 10 c_msd[4]
#variable        fitslope equal slope(f_9)/6/(10*dt)
variable        coef_diff equal fitslope[2]/10e-5

fix msd oxygen ave/time 1 1 50 v_coe_diff file twat.diff



compute rdf all rdf 1000 2 2 # oxygen-oxygen
fix rdf all ave/time ${Ne} ${Nr_rdf} ${Nrun} c_rdf[*] file twat.rdf mode vector
fix rdf all ave/time 10 ${Nr_rdf} ${Nrun} c_rdf[*] file twat.rdf mode vector
fix rdf all ave/time 10 500 ${Nrun} c_rdf[*] file twat.rdf mode vector
fix rdf all ave/time 10 500 10000 c_rdf[*] file twat.rdf mode vector

thermo_style custom step temp f_TempAve press f_PressAve f_PEAve_Mol f_DensAve v_coe_diff
thermo_modify flush yes
thermo ${Nf}
thermo 1000

dump trj all atom 100 twat.lammpstrj

run ${Nrun}
run 10000
PPPM initialization ...
  extracting TIP4P info from pair style
  using 12-bit tables for long-range coulomb (src/kspace.cpp:342)
  G vector (1/distance) = 0.24274564
  grid = 24 24 24
  stencil order = 5
  estimated absolute RMS force accuracy = 0.0024225467
  estimated relative force accuracy = 7.2954273e-06
  using double precision FFTW3
  3d grid and FFT values/proc = 29791 13824
WARNING: Communication cutoff 0 is shorter than a bond length based estimate of 3.4358. This may lead to errors. (src/comm.cpp:730)
WARNING: Increasing communication cutoff to 16.1118 for TIP4P pair style (src/KSPACE/pair_lj_cut_tip4p_long.cpp:497)
Generated 0 of 1 mixed pair_coeff terms from geometric mixing rule
Neighbor list info ...
  update: every = 1 steps, delay = 0 steps, check = yes
  max neighbors/atom: 2000, page size: 100000
  master list distance cutoff = 15.3092
  ghost atom cutoff = 16.1118
  binsize = 7.6546, bins = 5 5 5
  2 neighbor lists, perpetual/occasional/extra = 1 1 0
  (1) pair lj/cut/tip4p/long, perpetual
      attributes: half, newton on
      pair build: half/bin/newton
      stencil: half/bin/3d
      bin: standard
  (2) compute rdf, occasional, copy from (1)
      attributes: half, newton on
      pair build: copy
      stencil: none
      bin: none
Per MPI rank memory allocation (min/avg/max) = 28.29 | 28.29 | 28.29 Mbytes
   Step          Temp        f_TempAve        Press        f_PressAve    f_PEAve_Mol     f_DensAve      v_coe_diff  
         0   447.29957      0              26858.111      0              0              0              2.3680684e-17
      1000   299.20043      386.04377     -273.36377      21.296931     -10.164447      0.96910108     5.7851172    
      2000   298.05567      298.03289     -175.32116     -3.3697134     -11.333702      0.99961581     4.398191     
      3000   311.88725      298.06506      541.72599      20.819096     -11.381493      1.005142       3.5574082    
      4000   294.6601       297.74124      331.43739      7.6462341     -11.387801      1.0074946      3.4308413    
      5000   291.14852      298.34022      538.98148      4.9055216     -11.361271      0.99820115     3.1904936    
      6000   297.65046      297.88924      84.887283     -6.9968984     -11.38045       0.99454459     3.117661     
      7000   298.17589      297.55099      239.76742      7.4613588     -11.409329      0.98735541     2.9780589    
      8000   290.39085      297.9887      -422.75564     -31.348355     -11.437843      0.98418672     2.8315458    
      9000   300.03573      298.36632      558.43415      29.492277     -11.429644      0.99156168     2.7629407    
     10000   299.77452      297.76146      451.90823      33.699408     -11.408843      0.99458681     2.7517739    
Loop time of 1880.47 on 1 procs for 10000 steps with 3000 atoms

Performance: 0.919 ns/day, 26.118 hours/ns, 5.318 timesteps/s, 15.953 katom-step/s
102.3% CPU use with 1 MPI tasks x 1 OpenMP threads

MPI task timing breakdown:
Section |  min time  |  avg time  |  max time  |%varavg| %total
---------------------------------------------------------------
Pair    | 1665.3     | 1665.3     | 1665.3     |   0.0 | 88.56
Bond    | 0.031675   | 0.031675   | 0.031675   |   0.0 |  0.00
Kspace  | 62.023     | 62.023     | 62.023     |   0.0 |  3.30
Neigh   | 95.685     | 95.685     | 95.685     |   0.0 |  5.09
Comm    | 2.9074     | 2.9074     | 2.9074     |   0.0 |  0.15
Output  | 0.41363    | 0.41363    | 0.41363    |   0.0 |  0.02
Modify  | 53.394     | 53.394     | 53.394     |   0.0 |  2.84
Other   |            | 0.6809     |            |       |  0.04

Nlocal:           3000 ave        3000 max        3000 min
Histogram: 1 0 0 0 0 0 0 0 0 0
Nghost:          22292 ave       22292 max       22292 min
Histogram: 1 0 0 0 0 0 0 0 0 0
Neighs:    2.23105e+06 ave 2.23105e+06 max 2.23105e+06 min
Histogram: 1 0 0 0 0 0 0 0 0 0

Total # of neighbors = 2231054
Ave neighs/atom = 743.68467
Ave special neighs/atom = 2
Neighbor list builds = 894
Dangerous builds = 0

#write_restart restart.wat
Total wall time: 0:31:20
